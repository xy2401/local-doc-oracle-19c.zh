<html lang="en-us" dir="ltr" xml:lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>连续查询通知</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="JDBC Developer&#39;s Guide">
      <meta property="og:description" content="">
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="JDBC Developer&#39;s Guide">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="jdbc-developers-guide.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2019-02-13T13:20:37-08:00">
      <meta name="dcterms.title" content="JDBC Developer&#39;s Guide">
      <meta name="dcterms.dateCopyrighted" content="1999, 2019">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E96471-02">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/19">
      
      <link rel="prev" href="advanced-queuing.html" title="Previous" type="text/html">
      <link rel="next" href="high-availablility.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"19","element_name":"Release 19","display_in_url":true}}}</script>
      
    <meta name="dcterms.isVersionOf" content="JJDBC">
    <meta name="dcterms.release" content="Release 19">
  </head>
   <body dir="ltr">
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="advanced-queuing.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>上一页</a> <a href="high-availablility.html" class="pull-right">下一页<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a> <span class="fa fa-exclamation-triangle" aria-hidden="true"></span>必须启用JavaScript才能正确显示此内容</div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">JDBC开发人员指南</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="performance-and-scalability.html" property="item" typeof="WebPage"><span property="name">性能和可伸缩性</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">连续查询通知</li>
            </ol>
            <a id="GUID-4987516F-872F-47D1-B9E7-270A28D50AF8" name="GUID-4987516F-872F-47D1-B9E7-270A28D50AF8"></a><a id="JJDBC28815"></a>
            
            <h2 id="JJDBC-GUID-4987516F-872F-47D1-B9E7-270A28D50AF8" class="sect2"><span class="enumeration_chapter">27</span>连续查询通知</h2>
         </header>
         <div class="ind">
            <div>
               <p>本节介绍以下主题：</p>
               <ul style="list-style-type:disc">
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8">Continuos查询通知概述</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE">创建注册</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F">将查询与注册相关联</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8">通知数据库更改事件</a></p>
                  </li>
                  <li>
                     <p><a href="continuos-query-notification.html#GUID-17D0D7C5-77C9-420D-9D13-F668C1056792">删除注册</a></p>
                  </li>
               </ul>
            </div>
            <div class="props_rev_3"><a id="GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8" name="GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8"></a><h3 id="JJDBC-GUID-A66564C6-15CE-4D95-8AF6-E86954DD56C8" class="sect3"><span class="enumeration_section">27.1</span>连续查询通知概述</h3>
               <div>
                  <p>通常，中间层数据高速缓存会复制来自后端数据库服务器的某些数据。其目标是避免对数据库进行冗余查询。但是，仅当数据在数据库中很少更改时，这才有效。当数据库中的数据发生更改时，必须更新或无效数据高速缓存。从<span class="italic">11g</span>第1版开始，Oracle JDBC驱动程序为Oracle数据库的Continuous Query Notification功能提供支持。使用此功能，多层系统可以利用Continuous Query Notification功能，通过从JDBC驱动程序接收失效事件，使数据缓存尽可能保持最新。
                  </p>
                  <p>JDBC驱动程序可以向数据库注册SQL查询，并接收通知以响应以下内容：</p>
                  <ul style="list-style-type:disc">
                     <li>
                        <p>DML或DDL更改与查询关联的对象</p>
                     </li>
                     <li>
                        <p>影响结果集的DML或DDL更改</p>
                     </li>
                  </ul>
                  <p>在DML或DDL事务提交时发布通知（在本地事务中进行的更改在提交之前不会生成任何事件）。</p>
                  <p>要对连续查询通知使用Oracle JDBC驱动程序支持，请执行以下操作：</p>
                  <ol>
                     <li>
                        <p>注册：您首先需要创建注册。</p>
                     </li>
                     <li>
                        <p>查询关联：创建注册后，可以将SQL查询与其关联。这些查询是注册的一部分。</p>
                     </li>
                     <li>
                        <p>通知：创建通知以响应表或结果集中的更改。Oracle数据库通过专用网络连接将这些通知传递给JDBC驱动程序，JDBC驱动程序将这些通知转换为Java事件。</p>
                     </li>
                  </ol>
                  <p>此外，您需要向用户授予<code class="codeph">CHANGE NOTIFICATION</code>权限。例如，如果使用<code class="codeph">HR</code>用户名连接到数据库，则需要在数据库中运行以下命令：</p><pre class="oac_no_warn" dir="ltr">grant change notification to HR;
</pre></div>
            </div><a id="JJDBC28816"></a><div class="props_rev_3"><a id="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE" name="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE"></a><h3 id="JJDBC-GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE" class="sect3"><span class="enumeration_section">27.2</span>创建注册</h3>
               <div>
                  <div class="section">
                     <p>创建注册是一次性过程，在当前使用的事务之外完成。用于在服务器中创建注册的API在其自己的事务中执行，并立即提交。您需要JDBC连接才能创建注册，但是注册不会附加到连接。您可以在创建注册后关闭连接，并且注册仍然存在。在Oracle RAC环境中，注册是存在于所有节点上的持久实体。注册存在于数据库中。因此，即使节点发生故障，注册也会继续存在，并在表更改时得到通知。</p>
                     <p>有两种方法可以创建注册：</p>
                  </div>
                  <!-- class="section" -->
                  <div class="section">
                     <ul style="list-style-type:disc">
                        <li>
                           <p>JDBC注册方式：使用JDBC驱动程序在服务器上创建注册。JDBC驱动程序启动一个新线程，该线程侦听来自服务器的通知（通过专用通道），并将这些通知消息转换为Java事件。然后，驱动程序通知所有注册了该注册的听众。</p>
                        </li>
                        <li>
                           <p>PL / SQL样式的注册：如果您希望PL / SQL存储过程处理通知，则创建PL / SQL样式的注册。与JDBC样式的注册一样，JDBC驱动程序使您可以将语句（查询）附加到此注册。但是，JDBC驱动程序不会从服务器收到通知，因为通知由PL / SQL存储过程处理。</p>
                        </li>
                     </ul>
                     <div class="infoboxnote" id="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE__GUID-BA4D600F-5AB1-4140-91D9-B7E0B7087919">
                        <p class="notep1">注意：</p>
                        <p>此方法仅适用于非多线程语言，例如PHP。</p>
                     </div>
                     <p>无法从现有注册中删除一个特定对象（表）。解决方法是创建没有此对象的新注册，或忽略与此对象相关的事件。</p>
                     <p>您可以使用<code class="codeph">oracle.jdbc.的<code class="codeph">registerDatabaseChangeNotification</code>方法<code class="codeph">oracle.jdbc.OracleConnection</code>接口创建JDBC样式的注册。您可以通过此方法的<code class="codeph">options</code>参数设置某些注册选项。以下部分中的<span class="q">“连续查询通知注册选项”</span>表列出了一些可以设置的注册选项。要设置这些选项，请使用<code class="codeph">java.util.Properties</code>对象。这些选项在<code class="codeph">oracle.jdbc.中定义<code class="codeph">oracle.jdbc.OracleConnection</code>接口。注册选项会直接影响JDBC驱动程序将创建的通知事件。示例（本章末尾）说明了如何使用连续查询通知功能。
                     </p>
                     <p><code class="codeph">registerDatabaseChangeNotification</code>方法使用给定的选项在数据库服务器中创建新的数据库更改注册。它返回一个<code class="codeph">DatabaseChangeRegistration</code>对象，然后可以使用该对象将语句与此注册相关联。它还会打开一个侦听器套接字，数据库将使用该套接字发送通知。
                     </p>
                     <div class="infoboxnote" id="GUID-4DF06D46-82F0-462F-BE1A-4D4A0BD03FAE__GUID-A023C55E-14D5-4E46-8214-69CD567DE124">
                        <p class="notep1">注意：</p>
                        <p>如果存在侦听器套接字（由不同的注册创建），则新的数据库更改注册也将使用此套接字。</p>
                     </div>
                  </div>
                  <!-- class="section" -->
               </div><a id="JJDBC28817"></a><div class="props_rev_3"><a id="GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4" name="GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4"></a><h4 id="JJDBC-GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4" class="sect4"><span class="enumeration_section">27.2.1</span>连续查询通知注册选项</h4>
                  <div>
                     <div class="section">
                        <p>下表列出了连续查询通知注册选项：</p>
                     </div>
                     <!-- class="section" -->
                     <div class="tblformalwide" id="GUID-8A2BF5CA-CB76-4D88-B467-4A2AE63D89D4__CHDBDJHC">
                        <p class="titleintable">表27-1连续查询通知注册选项</p>
                        <table cellpadding="4" cellspacing="0" class="FormalWide" title="连续查询通知注册选项" width="100%" border="1" summary="table" frame="hsides" rules="rows">
                           <thead>
                              <tr align="left" valign="top">
                                 <th align="left" valign="bottom" width="35%" id="d73901e214">选项</th>
                                 <th align="left" valign="bottom" width="65%" id="d73901e217">描述</th>
                              </tr>
                           </thead>
                           <tbody>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e222" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_IGNORE_DELETEOP</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e222 d73901e217 ">
                                    <p>如果设置为<code class="codeph">true</code> ， <code class="codeph">DELETE</code>操作将不会生成任何数据库更改事件。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e236" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_IGNORE_INSERTOP</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e236 d73901e217 ">
                                    <p>如果设置为<code class="codeph">true</code> ，则<code class="codeph">INSERT</code>操作不会生成任何数据库更改事件。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e250" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_IGNORE_UPDATEOP</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e250 d73901e217 ">
                                    <p>如果设置为<code class="codeph">true</code> ，则<code class="codeph">UPDATE</code>操作不会生成任何数据库更改事件。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e264" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_NOTIFY_CHANGELAG</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e264 d73901e217 ">
                                    <p>指定客户端愿意滞后的事务数。</p>
                                    <p><span class="bold">注意：</span>如果将此选项设置为<code class="codeph">0</code>以外的任何值，则即使<code class="codeph">DCN_NOTIFY_ROWIDS</code>选项设置为<code class="codeph">true</code> ，也不会在事件中提供<code class="codeph">ROWID</code>级别的信息粒度。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e288" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_NOTIFY_ROWIDS</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e288 d73901e217 ">
                                    <p>数据库更改事件将包括行级详细信息，例如操作类型和<code class="codeph">ROWID</code> 。</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e299" headers="d73901e214 ">
                                    <p><code class="codeph">DCN_QUERY_CHANGE_NOTIFICATION</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e299 d73901e217 ">
                                    <p>激活查询更改通知而不是对象更改通知。</p>
                                    <p><span class="bold">注意：</span>此选项仅在针对11.0数据库运行时可用。
                                    </p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e311" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_LOCAL_HOST</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e311 d73901e217 ">
                                    <p>指定将从服务器接收通知的计算机的IP地址。</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e319" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_LOCAL_TCP_PORT</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e319 d73901e217 ">
                                    <p>指定驱动程序应用于侦听器套接字的TCP端口。</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e327" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_QOS_PURGE_ON_NTFN</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e327 d73901e217 ">
                                    <p>指定是否应在第一个通知事件上清除注册。</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e335" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_QOS_RELIABLE</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e335 d73901e217 ">
                                    <p>指定是否使通知持久，这会带来性能成本。</p>
                                 </td>
                              </tr>
                              <tr align="left" valign="top">
                                 <td align="left" valign="top" width="35%" id="d73901e343" headers="d73901e214 ">
                                    <p><code class="codeph">NTF_TIMEOUT</code></p>
                                 </td>
                                 <td align="left" valign="top" width="65%" headers="d73901e343 d73901e217 ">
                                    <p>指定数据库自动清除注册的时间（以秒为单位）。</p>
                                 </td>
                              </tr>
                           </tbody>
                        </table>
                     </div>
                     <!-- class="inftblhruleinformal" -->
                     <div class="section">
                        <p>如果存在注册，则还可以使用<code class="codeph">getDatabaseChangeRegistration</code>方法将现有注册映射到新的<code class="codeph">DatabaseChangeRegistration</code>对象。如果您使用PL / SQL创建了注册并希望将语句与其关联，则此方法特别有用。
                        </p>
                     </div>
                     <!-- class="section" -->
                  </div>
               </div>
            </div><a id="JJDBC28818"></a><div class="props_rev_3"><a id="GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F" name="GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F"></a><h3 id="JJDBC-GUID-6CA108CC-658D-447D-8B8A-ABBBF975871F" class="sect3"><span class="enumeration_section">27.3</span>将查询与注册关联</h3>
               <div>
                  <div class="section">
                     <p>创建注册或映射到现有注册后，您可以将查询与其关联。与创建注册一样，将查询与注册相关联是一次性过程，并且在当前使用的注册之外完成。即使本地事务已回滚，查询也将关联。</p>
                     <p>您可以使用<code class="codeph">OracleStatement</code>类中定义的<code class="codeph">setDatabaseChangeRegistration</code>方法将查询与注册相关联。此方法将<code class="codeph">DatabaseChangeRegistration</code>对象作为参数。以下代码段说明了如何将查询与注册相关联：</p><pre class="oac_no_warn" dir="ltr">...
// conn is an OracleConnection object.
// prop is a Properties object containing the registration options.
DatabaseChangeRegistration dcr = conn.registerDatabaseChangeNotifictaion(prop);
...
Statement stmt = conn.createStatement();
// associating the query with the registration
((OracleStatement)stmt).setDatabaseChangeRegistration(dcr);
// any query that will be executed with the 'stmt' object will be associated with
// the registration 'dcr' until 'stmt' is closed or
// '((OracleStatement)stmt).setDatabaseChangeRegistration(null);' is executed.
...
</pre></div>
                  <!-- class="section" -->
               </div>
            </div><a id="JJDBC28819"></a><div class="props_rev_3"><a id="GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8" name="GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8"></a><h3 id="JJDBC-GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8" class="sect3"><span class="enumeration_section">27.4</span>通知数据库更改事件</h3>
               <div>
                  <div class="section">
                     <p>要接收连续查询通知，请将注册程序附加到注册。发生数据库更改事件时，数据库服务器会通知JDBC驱动程序。然后，驱动程序构造新的Java事件，标识要通知的注册，并通知附加到注册的侦听器。该事件包含已更改的数据库对象的对象ID以及导致更改的操作类型。根据注册选项，事件还可能包含行级详细信息。然后，侦听器代码可以使用该事件来做出有关数据高速缓存的决策。</p>
                     <div class="infoboxnote" id="GUID-BFBDF82C-9F67-4270-979B-0928C9AF9BB8__GUID-7430853C-5CE4-4940-BD48-7133F9FE97F4">
                        <p class="notep1">注意：</p>
                        <p>侦听器代码不得减慢JDBC通知机制的速度。如果代码很耗时，例如，如果它通过查询数据库刷新数据缓存，那么它需要在自己的线程中执行。</p>
                     </div>
                     <p>您可以使用<code class="codeph">addListener</code>方法将侦听器附加到注册。以下代码段说明了如何将侦听器附加到注册：</p><pre class="oac_no_warn" dir="ltr">...
// conn is an OracleConnection object.
// prop is a Properties object containing the registration options.
DatabaseChangeRegistration dcr = conn.registerDatabaseChangeNotifictaion(prop);
...
// Attach the listener to the registration.
// Note: DCNListener is a custom listener and not a predefined or standard 
// lsiener
DCNListener list = new DCNListener();
dcr.addListener(list);
...
</pre></div>
                  <!-- class="section" -->
               </div>
            </div><a id="JJDBC28822"></a><a id="JJDBC28820"></a><div class="props_rev_3"><a id="GUID-17D0D7C5-77C9-420D-9D13-F668C1056792" name="GUID-17D0D7C5-77C9-420D-9D13-F668C1056792"></a><h3 id="JJDBC-GUID-17D0D7C5-77C9-420D-9D13-F668C1056792" class="sect3"><span class="enumeration_section">27.5</span>删除注册</h3>
               <div>
                  <div class="section">
                     <p>您需要显式取消注册注册以将其从服务器中删除并释放驱动程序中的资源。您可以使用与用于创建注册的连接不同的连接取消注册注册。要取消注册注册，可以使用<code class="codeph">oracle.jdbc.定义的<code class="codeph">unregisterDatabaseChangeNotification</code>方法<code class="codeph">oracle.jdbc.OracleConnection</code> 。
                     </p>
                     <p>您必须将<code class="codeph">DatabaseChangeRegistration</code>对象作为参数传递给此方法。此方法从服务器和驱动程序中删除注册并关闭侦听器套接字。
                     </p>
                     <p>如果注册是在JDBC之外创建的，比如说使用PL / SQL，则必须传递注册ID而不是<code class="codeph">DatabaseChangeRegistration</code>对象。该方法将从服务器中删除注册，但是，它不会释放驱动程序中的任何资源。
                     </p>
                     <p><a href="continuos-query-notification.html#GUID-17D0D7C5-77C9-420D-9D13-F668C1056792__CHDCJFGJ">例27-1</a>说明了如何使用Continuous Query Notification功能。在此示例中， <code class="codeph">HR</code>用户正在连接到数据库。因此，在数据库中，您需要向用户授予以下权限：</p><pre class="oac_no_warn" dir="ltr">grant change notification to HR;
</pre><p>此代码也适用于Oracle Database <span class="italic">10g</span>第2版（10.2）。此代码使用表注册。也就是说，当您注册<code class="codeph">SELECT</code>查询时，您注册的是所涉及的表的名称，而不是查询本身。换句话说，您可以选择一个表的一行，如果另一行更新，虽然您的查询结果没有更改，但会通知您。
                     </p>
                     <p>在此示例中，如果您打开注册而不是关闭它，则Continuous Query Notification线程将继续运行。现在，如果您运行更改<code class="codeph">HR.DEPARTMENTS</code>表并提交它的DML查询，例如从SQL * Plus，则Java程序将打印通知。
                     </p>
                  </div>
                  <!-- class="section" -->
                  <div class="example" id="GUID-17D0D7C5-77C9-420D-9D13-F668C1056792__CHDCJFGJ">
                     <p class="titleinexample">例27-1连续查询通知</p><pre class="oac_no_warn" dir="ltr">import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Properties;
import oracle.jdbc.OracleConnection;
import oracle.jdbc.OracleDriver;
import oracle.jdbc.OracleStatement;
import oracle.jdbc.dcn.DatabaseChangeEvent;
import oracle.jdbc.dcn.DatabaseChangeListener;
import oracle.jdbc.dcn.DatabaseChangeRegistration;
 
public class DBChangeNotification
{
  static final String USERNAME= "HR";
  static final String PASSWORD= "hr";
  static String URL;
  
  public static void main(String[] argv)
  {
    if(argv.length &lt; 1)
    {
      System.out.println("Error: You need to provide the URL in the first argument.");
      System.out.println("  For example: &gt; java -classpath .:ojdbc6.jar DBChangeNotification \"jdbc:oracle:thin:
@(DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=yourhost.yourdomain.com)(PORT=5221))(CONNECT_DATA=
(SERVICE_NAME=orcl)))\"");
 
      System.exit(1);
    }
    URL = argv[0];
    DBChangeNotification demo = new DBChangeNotification();
    try
    {
      demo.run();
    }
    catch(SQLException mainSQLException )
    {
      mainSQLException.printStackTrace();
    }
  }
 
  void run() throws SQLException
  {
    OracleConnection conn = connect();
      
    // first step: create a registration on the server:
    Properties prop = new Properties();
    
    // if connected through the VPN, you need to provide the TCP address of the client.
    // For example:
    // prop.setProperty(OracleConnection.NTF_LOCAL_HOST,"14.14.13.12");
 
    // Ask the server to send the ROWIDs as part of the DCN events (small performance
    // cost):
    prop.setProperty(OracleConnection.DCN_NOTIFY_ROWIDS,"true");
// 
//Set the DCN_QUERY_CHANGE_NOTIFICATION option for query registration with finer granularity.
 prop.setProperty(OracleConnection.DCN_QUERY_CHANGE_NOTIFICATION,"true");
 
    // The following operation does a roundtrip to the database to create a new
    // registration for DCN. It sends the client address (ip address and port) that
    // the server will use to connect to the client and send the notification
    // when necessary. Note that for now the registration is empty (we haven't registered
    // any table). This also opens a new thread in the drivers. This thread will be
    // dedicated to DCN (accept connection to the server and dispatch the events to 
    // the listeners).
    DatabaseChangeRegistration dcr = conn.registerDatabaseChangeNotification(prop);
 
    try
    {
      // add the listenerr:
      DCNDemoListener list = new DCNDemoListener(this);
      dcr.addListener(list);
       
      // second step: add objects in the registration:
      Statement stmt = conn.createStatement();
      // associate the statement with the registration:
      ((OracleStatement)stmt).setDatabaseChangeRegistration(dcr);
      ResultSet rs = stmt.executeQuery("select * from dept where deptno='45'");
      while (rs.next())
      {}
      String[] tableNames = dcr.getTables();
      for(int i=0;i&lt;tableNames.length;i++)
        System.out.println(tableNames[i]+" is part of the registration.");
      rs.close();
      stmt.close();
    }
    catch(SQLException ex)
    {
      // if an exception occurs, we need to close the registration in order
      // to interrupt the thread otherwise it will be hanging around.
      if(conn != null)
        conn.unregisterDatabaseChangeNotification(dcr);
      throw ex;
    }
    finally
    {
      try
      {
        // Note that we close the connection!
        conn.close();
      }
      catch(Exception innerex){ innerex.printStackTrace(); }
    }
    
    synchronized( this ) 
    {
      // The following code modifies the dept table and commits:
      try
      {
        OracleConnection conn2 = connect();
        conn2.setAutoCommit(false);
        Statement stmt2 = conn2.createStatement();
        stmt2.executeUpdate("insert into dept (deptno,dname) values ('45','cool dept')",
Statement.RETURN_GENERATED_KEYS);
        ResultSet autoGeneratedKey = stmt2.getGeneratedKeys();
        if(autoGeneratedKey.next())
          System.out.println("inserted one row with ROWID="+autoGeneratedKey.getString(1));      
        stmt2.executeUpdate("insert into dept (deptno,dname) values ('50','fun dept')",
Statement.RETURN_GENERATED_KEYS);
        autoGeneratedKey = stmt2.getGeneratedKeys();
        if(autoGeneratedKey.next())
          System.out.println("inserted one row with ROWID="+autoGeneratedKey.getString(1));
        stmt2.close();
        conn2.commit();
        conn2.close();
      }
      catch(SQLException ex) { ex.printStackTrace(); }
 
      // wait until we get the event
      try{ this.wait();} catch( InterruptedException ie ) {}
    }
    
    // At the end: close the registration (comment out these 3 lines in order
    // to leave the registration open).
    OracleConnection conn3 = connect();
    conn3.unregisterDatabaseChangeNotification(dcr);
    conn3.close();
  }
  
  /**
   * Creates a connection the database.
   */
  OracleConnection connect() throws SQLException
  {
    OracleDriver dr = new OracleDriver();
    Properties prop = new Properties();
    prop.setProperty("user",DBChangeNotification.USERNAME);
    prop.setProperty("password",DBChangeNotification.PASSWORD);
    return (OracleConnection)dr.connect(DBChangeNotification.URL,prop);
  }
}
/**
 * DCN listener: it prints out the event details in stdout.
 */
class DCNDemoListener implements DatabaseChangeListener
{
  DBChangeNotification demo;
  DCNDemoListener(DBChangeNotification dem)
  {
    demo = dem;
  }
  public void onDatabaseChangeNotification(DatabaseChangeEvent e)
  {
    Thread t = Thread.currentThread();
    System.out.println("DCNDemoListener: got an event ("+this+" running on thread "+t+")");
    System.out.println(e.toString());
    synchronized( demo ){ demo.notify();}
  }
}</pre></div>
                  <!-- class="example" -->
               </div>
            </div>
         </div>
      </article>
   </body>
</html>